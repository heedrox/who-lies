<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHO LIES - Murder Mystery Game</title>
    
    <!-- Firebase SDK 12.x Modular -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
        import { getFirestore, initializeFirestore, persistentLocalCache, persistentMultipleTabManager, onSnapshot, doc, setDoc, updateDoc, getDoc, collection, addDoc, orderBy, query, serverTimestamp, deleteField } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBS9NW_JTE5SyajdqsGF8qeCH7ROSAWFYo",
            authDomain: "the-anomaly-897ce.firebaseapp.com",
            databaseURL: "https://the-anomaly-897ce.firebaseio.com",
            projectId: "the-anomaly-897ce",
            storageBucket: "the-anomaly-897ce.firebasestorage.app",
            messagingSenderId: "136548028625",
            appId: "1:136548028625:web:437d1081024d3907edf5f0",
            measurementId: "G-8SJHHK4Y6G"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        
        // Initialize Firestore with persistent cache and multi-tab support
        const db = initializeFirestore(app, {
            localCache: persistentLocalCache({ 
                tabManager: persistentMultipleTabManager() 
            })
        });
        
        // Initialize Auth
        const auth = getAuth(app);
        
        // Make Firebase services available globally
        window.firebaseServices = {
            app,
            db,
            auth,
            onSnapshot,
            doc,
            setDoc,
            updateDoc,
            getDoc,
            collection,
            addDoc,
            orderBy,
            query,
            serverTimestamp,
            deleteField,
            onAuthStateChanged,
            signInAnonymously,
            signOut
        };
        
        // Make auth available globally for the observer
        window.auth = auth;
        
        console.log('‚úÖ Firebase 12.x inicializado con cach√© persistente y soporte multi-tab');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(90deg, #8b0000 0%, #a52a2a 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.2rem;
            margin-top: 10px;
            opacity: 0.9;
            font-style: italic;
        }

        .main-content {
            flex: 1;
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        /* Login section styles */
        .login-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }

        .login-title {
            font-size: 2rem;
            color: #ff4444;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .login-description {
            font-size: 1.1rem;
            margin-bottom: 30px;
            opacity: 0.9;
            max-width: 400px;
            line-height: 1.5;
        }

        .login-btn {
            background: linear-gradient(145deg, #ff4444, #cc0000);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            background: linear-gradient(145deg, #ff6666, #dd2222);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Player Count Selection Styles */
        .player-count-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .player-count-option {
            background: linear-gradient(145deg, #2a2a2a, #3a3a3a);
            border: 2px solid #8b0000;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .player-count-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            border-color: #ff4444;
            background: linear-gradient(145deg, #3a3a3a, #4a4a4a);
        }

        .player-count-option:active {
            transform: translateY(-1px);
        }

        .player-count-option.selected {
            background: linear-gradient(145deg, #8b0000, #a52a2a);
            border-color: #ff4444;
            box-shadow: 0 6px 20px rgba(139,0,0,0.6);
        }

        .player-count-option.selected:hover {
            background: linear-gradient(145deg, #a52a2a, #c04040);
            border-color: #ff6666;
        }

        .player-count-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ff4444;
        }

        .player-count-label {
            font-size: 0.8rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Player Selection Grid Styles */
        .player-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .player-selection-option {
            background: linear-gradient(145deg, #2a2a2a, #3a3a3a);
            border: 2px solid #8b0000;
            border-radius: 12px;
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            user-select: none;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
        }

        .player-selection-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            border-color: #ff4444;
            background: linear-gradient(145deg, #3a3a3a, #4a4a4a);
        }

        .player-selection-option:active {
            transform: translateY(-1px);
        }

        .player-selection-option.selected {
            background: linear-gradient(145deg, #8b0000, #a52a2a);
            border-color: #ff4444;
            box-shadow: 0 6px 20px rgba(139,0,0,0.6);
        }

        .player-selection-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ff4444;
        }

        .player-selection-label {
            font-size: 0.8rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>WHO LIES</h1>
        <div class="subtitle">Murder Mystery Game</div>
    </header>

    <main class="main-content">
        <!-- Login Section -->
        <div id="login-section" class="login-section">
            <p class="login-description">
                Para comenzar a jugar, con√©ctate an√≥nimamente. 
                No se guardar√° informaci√≥n personal, solo un ID √∫nico para tu sesi√≥n.
            </p>
            
            <button id="login-btn" class="login-btn" onclick="handleAnonymousLogin()">
                üë§ JUGAR AN√ìNIMAMENTE
            </button>
        </div>

        <!-- Player Count Selection Section -->
        <div id="player-count-selection-section" class="login-section" style="display: none;">
            <h2 class="login-title">N√öMERO DE JUGADORES</h2>
            <div id="player-count-options" class="player-count-options">
                <!-- Player count options will be generated dynamically -->
            </div>
        </div>

        <!-- Player Selection Section -->
        <div id="player-selection-section" class="login-section" style="display: none;">
            <h2 class="login-title">SELECCIONA TU JUGADOR</h2>
            <div id="player-options" class="player-options">
                <!-- Player options will be generated dynamically -->
            </div>
        </div>
    </main>

    <!-- Firebase Modular Configuration -->
    <script src="firebase-modular.js"></script>
    
    <script>
        console.log('üéÆ Script HTML iniciando...');
        
        // Funci√≥n para obtener par√°metros de la URL
        function getUrlParams() {
            const queryString = window.location.search;
            
            console.log('üîç getUrlParams() ejecut√°ndose...');
            console.log('üîç Analizando URL:', window.location.href);
            console.log('üîç Query string:', queryString);
            console.log('üîç Query string length:', queryString.length);

            // 1) Formato: ?g/CODIGO_JUEGO ‚Üí selecci√≥n de n√∫mero de jugadores
            const gameCodeOnlyMatch = queryString.match(/\?g\/([^\/]+)$/);
            if (gameCodeOnlyMatch) {
                console.log('üéÆ Patr√≥n ?g/CODIGO_JUEGO detectado:', gameCodeOnlyMatch[1]);
                return {
                    gameCode: gameCodeOnlyMatch[1],
                    playerNumber: null,
                    totalPlayers: null,
                    needsPlayerSelection: false,
                    needsPlayerCountSelection: true
                };
            }

            // 2) Formato: ?g/CODIGO_JUEGO/p/x/TOTAL ‚Üí selecci√≥n de jugador pendiente
            const playerSelectionMatch = queryString.match(/\?g\/([^\/]+)\/p\/x\/(\d+)$/);
            if (playerSelectionMatch) {
                console.log('üéÆ Patr√≥n ?g/CODIGO_JUEGO/p/x/TOTAL detectado:', playerSelectionMatch[1], playerSelectionMatch[2]);
                return {
                    gameCode: playerSelectionMatch[1],
                    playerNumber: null,
                    totalPlayers: Number(playerSelectionMatch[2]),
                    needsPlayerSelection: true,
                    needsPlayerCountSelection: false
                };
            }

            // 3) Formato: ?g/CODIGO_JUEGO/p/NUM/TOTAL ‚Üí juego con jugador ya seleccionado
            const fullPlayerMatch = queryString.match(/\?g\/([^\/]+)\/p\/(\d+)\/(\d+)$/);
            if (fullPlayerMatch) {
                console.log('üéÆ Patr√≥n ?g/CODIGO_JUEGO/p/NUM/TOTAL detectado:', fullPlayerMatch[1], fullPlayerMatch[2], fullPlayerMatch[3]);
                return {
                    gameCode: fullPlayerMatch[1],
                    playerNumber: Number(fullPlayerMatch[2]),
                    totalPlayers: Number(fullPlayerMatch[3]),
                    needsPlayerSelection: false,
                    needsPlayerCountSelection: false
                };
            }

            console.log('‚ùå No se detectaron par√°metros de URL v√°lidos');
            return null;
        }

        // Funci√≥n principal que se ejecuta al cargar la p√°gina
        function initializeGame() {
            console.log('üéÆ initializeGame() ejecut√°ndose...');
            console.log('üéÆ window.location.href:', window.location.href);
            console.log('üéÆ window.location.search:', window.location.search);
            
            const params = getUrlParams();
            console.log('üéÆ Par√°metros obtenidos de getUrlParams():', params);
            
            if (params) {
                console.log(`üéÆ C√≥digo del juego: ${params.gameCode}`);
                console.log(`üéÆ Total de jugadores: ${params.totalPlayers}`);
                
                // Guardar par√°metros globalmente para usar despu√©s de la autenticaci√≥n
                window.gameParams = params;
                console.log('üéÆ window.gameParams configurado:', window.gameParams);
                
                if (params.needsPlayerCountSelection || params.needsPlayerSelection) {
                    console.log('üéÆ Par√°metros detectados, esperando autenticaci√≥n...');
                    // Asegurar que solo se muestre la pantalla de login
                    const loginSection = document.getElementById('login-section');
                    const playerCountSection = document.getElementById('player-count-selection-section');
                    const playerSelectionSection = document.getElementById('player-selection-section');

                    if (loginSection) loginSection.style.display = 'flex';
                    if (playerCountSection) playerCountSection.style.display = 'none';
                    if (playerSelectionSection) playerSelectionSection.style.display = 'none';
                }
            } else {
                console.log('üéÆ Juego iniciado sin par√°metros de URL');
            }
        }

        // Funci√≥n para mostrar la pantalla de selecci√≥n del n√∫mero de jugadores
        function showPlayerCountSelectionScreen(params) {
            console.log('üéÆ Mostrando pantalla de selecci√≥n del n√∫mero de jugadores');
            
            // Ocultar todas las secciones
            const loginSection = document.getElementById('login-section');
            
            if (loginSection) loginSection.style.display = 'none';
            
            // Mostrar secci√≥n de selecci√≥n del n√∫mero de jugadores
            const playerCountSelectionSection = document.getElementById('player-count-selection-section');
            if (playerCountSelectionSection) {
                playerCountSelectionSection.style.display = 'block';
            }
            
            // Generar opciones de n√∫mero de jugadores (4 a 12)
            const playerCountOptions = document.getElementById('player-count-options');
            if (playerCountOptions) {
                playerCountOptions.innerHTML = '';
                
                for (let i = 4; i <= 12; i++) {
                    const playerCountOption = document.createElement('div');
                    playerCountOption.className = 'player-count-option';
                    playerCountOption.onclick = () => selectPlayerCount(i, params);
                    
                    playerCountOption.innerHTML = `
                        <div class="player-count-number">${i}</div>
                    `;
                    
                    playerCountOptions.appendChild(playerCountOption);
                }
            }
        }

        // Funci√≥n para seleccionar el n√∫mero de jugadores
        function selectPlayerCount(totalPlayers, params) {
            console.log(`üéÆ N√∫mero de jugadores seleccionado: ${totalPlayers}`);
            console.log(`üéÆ Par√°metros del juego:`, params);
            
            // Construir la URL de redirecci√≥n para selecci√≥n de jugador espec√≠fico
            const gameCode = params.gameCode;
            const redirectUrl = `?g/${gameCode}/p/x/${totalPlayers}`;
            
            console.log(`üéÆ Redirigiendo a: ${redirectUrl}`);
            
            // Redirigir a la pantalla de selecci√≥n de jugador espec√≠fico
            window.location.href = redirectUrl;
        }

        // Funci√≥n para mostrar la pantalla de selecci√≥n de jugador espec√≠fico
        function showPlayerSelectionScreen(params) {
            console.log('üéÆ Mostrando pantalla de selecci√≥n de jugador espec√≠fico');

            // Ocultar todas las secciones
            const loginSection = document.getElementById('login-section');
            const playerCountSelectionSection = document.getElementById('player-count-selection-section');
            if (loginSection) loginSection.style.display = 'none';
            if (playerCountSelectionSection) playerCountSelectionSection.style.display = 'none';

            // Mostrar secci√≥n de selecci√≥n de jugador
            const playerSelectionSection = document.getElementById('player-selection-section');
            if (playerSelectionSection) playerSelectionSection.style.display = 'block';

            // Generar opciones de jugador (1..totalPlayers)
            const playerOptions = document.getElementById('player-options');
            if (playerOptions) {
                playerOptions.innerHTML = '';
                for (let i = 1; i <= (params.totalPlayers || 0); i++) {
                    const option = document.createElement('div');
                    option.className = 'player-selection-option';
                    option.onclick = () => selectPlayerNumber(i, params);
                    option.innerHTML = `
                        <div class="player-selection-label">JUG.</div>
                        <div class="player-selection-number">${i}</div>
                    `;
                    playerOptions.appendChild(option);
                }
            }
        }

        // Funci√≥n para seleccionar un jugador espec√≠fico
        function selectPlayerNumber(playerNumber, params) {
            console.log(`üéÆ Jugador seleccionado: ${playerNumber}`);
            const gameCode = params.gameCode;
            const totalPlayers = params.totalPlayers;
            const redirectUrl = `?g/${gameCode}/p/${playerNumber}/${totalPlayers}`;
            console.log(`üéÆ Redirigiendo a: ${redirectUrl}`);
            window.location.href = redirectUrl;
        }

        // Funci√≥n de login an√≥nimo con Firebase
        async function handleAnonymousLogin() {
            const loginBtn = document.getElementById('login-btn');
            const originalText = loginBtn.textContent;
            
            try {
                loginBtn.textContent = 'Conectando...';
                loginBtn.classList.add('loading');
                
                // Simular autenticaci√≥n exitosa (sin Firebase)
                console.log('üîê Login an√≥nimo simulado');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                console.log('‚úÖ Usuario autenticado exitosamente');
                
                // Mostrar la pantalla correspondiente tras autenticaci√≥n
                if (window.gameParams) {
                    if (window.gameParams.needsPlayerCountSelection) {
                        console.log('üéÆ Mostrando pantalla de selecci√≥n del n√∫mero de jugadores despu√©s de autenticaci√≥n');
                        showPlayerCountSelectionScreen(window.gameParams);
                    } else if (window.gameParams.needsPlayerSelection) {
                        console.log('üéÆ Mostrando pantalla de selecci√≥n de jugador despu√©s de autenticaci√≥n');
                        showPlayerSelectionScreen(window.gameParams);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error en login:', error);
                alert('Error al conectar. Por favor, intenta de nuevo.');
                
                // Reset button
                loginBtn.textContent = originalText;
                loginBtn.classList.remove('loading');
            }
        }

        // Ejecutar inicializaci√≥n cuando se carga la p√°gina
        console.log('üéÆ Configurando event listener para DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéÆ Evento DOMContentLoaded disparado');
            try {
                initializeGame();
            } catch (error) {
                console.error('‚ùå Error en initializeGame:', error);
            }
        });
    </script>
</body>
</html>
