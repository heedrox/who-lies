# 0004_PLAN.md - Evaluación Dual de Bombas

## Descripción de la Funcionalidad

Extender el sistema de bombas existente para evaluar las muertes por bomba en dos momentos distintos:
1. **ANTES del movimiento**: Si un jugador está en una habitación con bomba al inicio de la fase de movimiento, muere inmediatamente.
2. **DESPUÉS del movimiento**: Si un jugador se mueve a una habitación con bomba durante la fase de movimiento, muere al finalizar la ronda.

Esta funcionalidad mantiene la mecánica actual pero añade la evaluación previa al movimiento, creando un sistema de doble evaluación que hace las bombas más letales y estratégicas.

## Archivos y Funciones a Modificar

### 1. Lógica de Evaluación de Bombas

**Archivo**: `web/firebase-modular.js`

**Funciones a modificar**:
- `startRoundEnding(gameCode)` - Agregar evaluación de bombas antes del movimiento
- `finalizeRound(gameCode, newDistribution, newVisibility)` - Mantener evaluación después del movimiento

**Nuevas funciones a crear**:
- `checkPreMovementBombDeaths(gameData)` - Verificar muertes por bomba antes del movimiento
- `processPreMovementBombDeaths(gameData)` - Procesar y aplicar muertes por bomba previas al movimiento

### 2. Interfaz de Usuario

**Archivo**: `web/index.html`

**Funciones a modificar**:
- `enableMovementMode(gameData)` - Verificar si hay muertes por bomba antes de habilitar movimiento
- `handleGameUpdate(gameData)` - Procesar actualizaciones de estado de bombas en tiempo real

**Nuevas funciones a crear**:
- `showPreMovementBombAlert(deaths)` - Mostrar alerta de muertes por bomba antes del movimiento
- `disableMovementForDeadPlayers()` - Deshabilitar movimiento para jugadores muertos por bomba

### 3. Gestión de Estado del Juego

**Archivo**: `web/firebase-modular.js`

**Funciones a modificar**:
- `updatePlayerMovement(gameCode, playerNumber, nextMovement)` - Validar que el jugador no esté muerto por bomba
- `checkAllPlayersMoved(gameCode, totalPlayers)` - Considerar jugadores muertos por bomba como "movidos"

## Algoritmo de Evaluación Dual de Bombas

### Paso 1: Evaluación Pre-Movimiento
1. Cuando se inicia la fase de movimiento (`startRoundEnding()`)
2. Verificar si hay bomba colocada (`gameData.bombPlaced !== null`)
3. Obtener habitación con bomba (`bombRoom = gameData.bombPlaced`)
4. Identificar jugadores vivos en la habitación con bomba usando `gameData.playerDistribution[bombRoom]`
5. Filtrar jugadores vivos (excluir `gameData.deads`)
6. Marcar estos jugadores como muertos inmediatamente
7. Actualizar `gameData.deads` en Firebase
8. Mostrar alerta a todos los jugadores sobre las muertes

### Paso 2: Evaluación Post-Movimiento (Existente)
1. Al finalizar la ronda (`finalizeRound()`)
2. Verificar si hay bomba colocada
3. Usar `newDistribution` para identificar jugadores en habitación con bomba
4. Filtrar jugadores vivos
5. Agregar muertes por bomba al array de muertos

### Paso 3: Validaciones de Movimiento
1. En `updatePlayerMovement()`, verificar que el jugador no esté muerto
2. En `checkAllPlayersMoved()`, considerar jugadores muertos por bomba como "movidos"
3. En la UI, deshabilitar selección de habitaciones para jugadores muertos

## Flujo de Ejecución Detallado

### Inicio de Fase de Movimiento
```
1. Usuario hace clic "INICIAR RONDA" (jugador 1)
2. Se llama a startRoundEnding()
3. Se establece endingRound = true
4. NUEVO: Se llama a checkPreMovementBombDeaths()
5. NUEVO: Si hay muertes, se procesan y actualizan en Firebase
6. NUEVO: Se muestra alerta de muertes por bomba
7. Se habilita modo de movimiento para jugadores vivos
```

### Durante el Movimiento
```
1. Jugadores vivos pueden moverse normalmente
2. Jugadores muertos por bomba no pueden moverse
3. El asesino puede colocar bombas (mecánica existente)
```

### Fin de Fase de Movimiento
```
1. Se calcula newDistribution con movimientos
2. Se llama a finalizeRound()
3. Se evalúan muertes por bomba post-movimiento (existente)
4. Se combinan todas las muertes
5. Se actualiza el estado del juego
```

## Casos de Uso

### Caso 1: Bomba Previa al Movimiento
- **Situación**: Asesino colocó bomba en "COCINA" en ronda anterior
- **Al inicio de ronda**: Jugador 2 está en "COCINA" → muere inmediatamente
- **Durante movimiento**: Jugador 2 no puede moverse (ya está muerto)
- **Resultado**: Jugador 2 eliminado antes de que pueda actuar

### Caso 2: Bomba Durante el Movimiento
- **Situación**: No hay bomba al inicio de la ronda
- **Durante movimiento**: Asesino coloca bomba en "PASILLO NORTE"
- **Jugador 3** se mueve a "PASILLO NORTE"
- **Al finalizar**: Jugador 3 muere por bomba
- **Resultado**: Jugador 3 muere después de moverse

### Caso 3: Doble Evaluación
- **Situación**: Bomba en "COCINA" de ronda anterior
- **Al inicio**: Jugador 2 en "COCINA" → muere inmediatamente
- **Durante movimiento**: Jugador 3 se mueve a "COCINA"
- **Al finalizar**: Jugador 3 también muere por bomba
- **Resultado**: Dos jugadores mueren por la misma bomba

## Validaciones de Negocio

1. **Solo jugadores vivos pueden moverse**: Verificar `!gameData.deads.includes(playerNumber)` antes de permitir movimiento
2. **Jugadores muertos por bomba se consideran "movidos"**: Para evitar que bloqueen la finalización de ronda
3. **Bombas persisten entre rondas**: `gameData.bombPlaced` no se resetea automáticamente
4. **Evaluación en orden correcto**: Pre-movimiento primero, luego post-movimiento
5. **Sincronización en tiempo real**: Todas las actualizaciones se reflejan inmediatamente en todos los clientes

## Estructura de Datos

```javascript
// No se requieren cambios en la estructura existente
// gameData.bombPlaced sigue siendo null o "roomName"
// gameData.deads sigue siendo un array de números de jugador
```

## Notas de Implementación

- Mantener compatibilidad total con el sistema existente
- Las bombas siguen siendo visibles solo para el asesino
- Los botones de bomba siguen funcionando igual
- La mecánica de colocación de bombas no cambia
- Solo se añade la evaluación pre-movimiento
- Considerar el impacto en la UX: mostrar claramente cuándo alguien muere por bomba

## Fases de Implementación

### Fase 1: Evaluación Pre-Movimiento (Feature 1)
- Modificar `startRoundEnding()` para incluir evaluación de bombas
- Crear `checkPreMovementBombDeaths()` y `processPreMovementBombDeaths()`
- Actualizar estado en Firebase cuando hay muertes pre-movimiento

### Fase 2: Validaciones de Movimiento (Feature 2)
- Modificar `updatePlayerMovement()` para validar jugadores vivos
- Modificar `checkAllPlayersMoved()` para considerar jugadores muertos
- Actualizar UI para deshabilitar movimiento de jugadores muertos

### Fase 3: Interfaz de Usuario (Feature 3)
- Crear `showPreMovementBombAlert()` para notificar muertes
- Modificar `enableMovementMode()` para manejar jugadores muertos
- Actualizar `handleGameUpdate()` para procesar cambios de estado

## Consideraciones de UX

- Mostrar alerta clara cuando alguien muere por bomba antes del movimiento
- Indicar visualmente qué jugadores están muertos y no pueden moverse
- Mantener la información de bombas visible solo para el asesino
- Asegurar que las notificaciones de muerte sean claras y no confusas
