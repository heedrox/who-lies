# Plan Técnico: Minijuego de Sonidos para Visibilidad

## Descripción de la funcionalidad

Se requiere implementar un minijuego de sonidos que reemplace el sistema actual de visibilidad basado en probabilidad (60%) por un sistema basado en la habilidad de los jugadores para identificar sonidos. El minijuego se activa después del movimiento y determina la visibilidad de cada jugador para la siguiente ronda.

## Archivos y funciones que deben cambiarse

### 1. Archivo: `web/index.html`

#### Cambios en la estructura HTML:
- **Línea ~3056**: Modificar la lógica del botón "SIGUIENTE RONDA" para activar el minijuego
- **Línea ~1208**: Agregar overlay marrón para el minijuego con botones "MOVERSE" e "INVESTIGAR"
- **Línea ~2710**: Modificar la generación de `player-status-cell` para mostrar interfaz de selección de sonidos

#### Cambios en JavaScript:
- **Función `finalizeRoundAndRecalculate` (línea ~2635)**: Integrar cálculo de visibilidad basado en aciertos del minijuego
- **Función `startRoundEnding` (línea ~3050)**: Agregar lógica para activar estado "MOVING" y generar `movementSounds`
- **Nueva función**: `activateSoundMinigame()` para iniciar el minijuego
- **Nueva función**: `playMovementSounds()` para reproducir sonidos de movimiento
- **Nueva función**: `showSoundSelectionInterface()` para mostrar interfaz de selección de sonidos
- **Nueva función**: `calculateVisibilityFromAccuracy()` para calcular visibilidad basada en aciertos

### 2. Archivo: `web/firebase-modular.js`

#### Cambios en funciones existentes:
- **Función `startRoundEnding` (línea ~133)**: Agregar campos `state: "MOVING"` y `movementSounds` al documento del juego
- **Función `finalizeRound` (línea ~200)**: Integrar cálculo de visibilidad basado en aciertos del minijuego

#### Nueva función:
- **Función `saveSoundSelection`**: Para guardar la selección de sonidos de cada jugador
- **Función `checkAllPlayersInvestigated`**: Para verificar si todos los jugadores han completado la investigación
- **Función `calculatePlayerAccuracy`**: Para calcular el porcentaje de aciertos de cada jugador

### 3. Archivo: `web/sounds/`
- **Archivos existentes**: `sound-1.mp3`, `sound-2.mp3`, `sound-3.mp3` (ya disponibles)

## Algoritmo paso a paso

### 1. Activación del minijuego
1. Jugador 1 pulsa "SIGUIENTE RONDA"
2. Se guarda en BD: `state: "MOVING"` y `movementSounds: { 1: 1, 2: 1, 3: 3, ... }`
3. `movementSounds` asigna aleatoriamente sonidos 1, 2 o 3 a cada jugador
4. Todas las pantallas se vuelven marrones con overlay

### 2. Fase de movimiento
1. Overlay marrón con botón "MOVERSE" en el centro
2. Al pulsar "MOVERSE", contador regresivo: 5-4-3-2-1-0
3. En el segundo 0, cada dispositivo reproduce su sonido asignado
4. Botón cambia a "INVESTIGAR"

### 3. Fase de investigación
1. Al pulsar "INVESTIGAR", se muestra lista de usuarios
2. Para cada jugador, el usuario debe seleccionar qué sonido escuchó
3. Interfaz usable con opciones de sonido 1, 2 o 3 para cada jugador
4. Botón "CONTINUAR INVESTIGACION" para confirmar selecciones

### 4. Cálculo de aciertos
1. Cuando todos han pulsado "CONTINUAR INVESTIGACION"
2. Sistema calcula porcentaje de aciertos para cada jugador
3. Ejemplo: 3 aciertos de 4 = 75% de acierto
4. Este porcentaje reemplaza el 60% fijo para calcular visibilidad

### 5. Continuación del juego
1. Nueva distribución y visibilidad se calculan usando porcentajes de acierto
2. Partida continúa normalmente con el sistema de visibilidad actualizado

## Estructura de datos en Firebase

### Nuevos campos en el documento del juego:
```javascript
{
  // ... campos existentes
  state: "MOVING", // Estado del minijuego
  movementSounds: {
    1: 1,  // Jugador 1: sonido 1
    2: 1,  // Jugador 2: sonido 1
    3: 3,  // Jugador 3: sonido 3
    // ... hasta totalPlayers
  },
  soundSelections: {
    1: { 1: 1, 2: 1, 3: 3, ... }, // Selección del jugador 1
    2: { 1: 2, 2: 1, 3: 3, ... }, // Selección del jugador 2
    // ... hasta totalPlayers
  },
  investigationCompleted: {
    1: false, 2: false, 3: false, ... // Estado de investigación
  }
}
```

### Cálculo de visibilidad:
```javascript
// Antes (probabilidad fija del 60%)
visibility = Math.random() < 0.6

// Ahora (basado en aciertos del minijuego)
const accuracy = calculatePlayerAccuracy(playerNumber);
const visibilityThreshold = accuracy / 100; // Convertir 75% a 0.75
visibility = Math.random() < visibilityThreshold;
```

## Fases de implementación

### Fase 1: Capa de datos
- Modificar `startRoundEnding` para incluir `state: "MOVING"` y `movementSounds`
- Crear función `saveSoundSelection` para guardar selecciones de sonidos
- Crear función `checkAllPlayersInvestigated` para verificar completitud
- Crear función `calculatePlayerAccuracy` para calcular porcentajes de acierto

### Fase 2A: Interfaz del minijuego
- Implementar overlay marrón con botones "MOVERSE" e "INVESTIGAR"
- Crear contador regresivo 5-4-3-2-1-0
- Implementar reproducción automática de sonidos
- Crear interfaz de selección de sonidos para cada jugador

### Fase 2B: Lógica del minijuego
- Implementar función `activateSoundMinigame()` para coordinar el flujo
- Implementar función `playMovementSounds()` para sincronización de sonidos
- Implementar función `showSoundSelectionInterface()` para la interfaz de investigación
- Integrar cálculo de visibilidad basado en aciertos en `finalizeRoundAndRecalculate`

### Fase 2C: Integración con sistema existente
- Modificar `finalizeRoundAndRecalculate` para usar porcentajes de acierto
- Integrar con sistema de visibilidad existente
- Mantener compatibilidad con roles especiales (ASESINO y COMPLICE)

## Detalles específicos del prompt del usuario

- **Activación**: Al pulsar "SIGUIENTE RONDA" por el jugador 1
- **Estado en BD**: `state: "MOVING"` y `movementSounds: { 1: 1, 2: 1, 3: 3, ... }`
- **Sonidos disponibles**: Solo 3 sonidos (1, 2, 3) asignados aleatoriamente
- **Overlay**: Pantalla marrón con botón central "MOVERSE"
- **Contador**: Regresivo 5-4-3-2-1-0 segundos
- **Reproducción**: Automática en el segundo 0 para cada dispositivo
- **Interfaz de investigación**: Lista de usuarios con selección de sonidos para cada uno
- **Botón de confirmación**: "CONTINUAR INVESTIGACION" para cada jugador
- **Cálculo de aciertos**: Porcentaje basado en selecciones correctas vs. total de jugadores
- **Reemplazo del 60%**: El porcentaje de acierto se usa para calcular visibilidad de contrincantes
- **Continuidad**: El juego continúa normalmente después del minijuego
- **Sincronización**: Todos los jugadores deben completar la investigación antes de continuar
