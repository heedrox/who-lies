# 0003_PLAN.md - Sistema de Bombas del Asesino

## Descripci贸n de la Funcionalidad

Implementar un sistema de bombas que permite al asesino colocar una bomba durante la fase de movimiento. La mec谩nica incluye:

- **Colocaci贸n**: Durante la fase de movimiento, el asesino puede colocar una bomba en su habitaci贸n actual o en una de las habitaciones contiguas
- **Interfaz**: Botones "SOLTAR BOMBA" aparecen en habitaciones v谩lidas durante el modo de movimiento
- **Visualizaci贸n**: Emoji de bomba  visible solo para el asesino en el mapa
- **Restricciones**: Solo una bomba por partida, no se puede quitar una vez colocada
- **Persistencia**: La bomba permanece visible en rondas posteriores
- **Mec谩nica de muerte**: Cuando termina la fase de movimiento, si el jugador objetivo se mueve a una habitaci贸n con bomba, muere autom谩ticamente

## Archivos y Funciones a Modificar

### 1. Estructura de Base de Datos (Firebase)

**Archivo**: `web/firebase-modular.js`

**Funciones a modificar**:
- `savePlayerDistribution()` - Agregar campos iniciales de bombas
- `finalizeRound()` - Limpiar campos de bombas si es necesario
- `updateGameState()` - Soporte para actualizaciones de bombas

**Nuevos campos en la estructura de datos**:
```javascript
{
  // ... campos existentes ...
  bombPlaced: null,          // null o "cocina" (nombre de la habitaci贸n)
}
```

### 2. L贸gica de Colocaci贸n de Bombas

**Archivo**: `web/firebase-modular.js`

**Nuevas funciones a crear**:
- `placeBomb(gameCode, roomName)` - Colocar bomba con validaciones
- `getBombLocation(gameCode)` - Obtener ubicaci贸n de la bomba (null si no hay)
- `validateBombPlacement(playerNumber, roomName, gameData)` - Validar si se puede colocar bomba
- `getBombEligibleRooms(playerNumber, gameData)` - Obtener habitaciones donde se puede colocar bomba

**Validaciones a implementar**:
- Solo el asesino puede colocar bombas
- Solo en habitaci贸n actual o contiguas
- Solo una bomba por partida
- Solo durante fase de movimiento

### 3. Interfaz de Usuario para Colocaci贸n

**Archivo**: `web/index.html`

**Funciones a modificar**:
- `enableRoomSelection()` - Agregar l贸gica para mostrar botones de bomba
- `handleRoomSelection()` - Integrar colocaci贸n de bomba con movimiento
- `isRoomAccessible()` - Incluir validaci贸n de bombas

**Nuevas funciones a crear**:
- `showBombButtons(gameData)` - Mostrar botones "SOLTAR BOMBA" en habitaciones v谩lidas
- `hideBombButtons()` - Ocultar botones de bomba
- `handleBombPlacement(roomName)` - Manejar clic en bot贸n de bomba
- `isBombPlacementAllowed(playerNumber, roomName, gameData)` - Validar si se puede colocar bomba

**Funciones existentes a reutilizar**:
- `getCurrentPlayerRoom(playerNumber, distribution)` - Obtener habitaci贸n actual del jugador
- `isRoomAccessible(targetRoom, currentPlayer, playerRole, gameData)` - L贸gica de habitaciones contiguas

**Elementos UI a agregar**:
- Botones "SOLTAR BOMBA" peque帽os en habitaciones v谩lidas
- Integraci贸n con el sistema de movimiento existente

### 4. Visualizaci贸n de Bombas en el Mapa

**Archivo**: `web/index.html`

**Funciones a modificar**:
- `updateRoomDisplay()` - Agregar emoji de bomba en la habitaci贸n correspondiente
- `handleGameUpdate()` - Procesar actualizaciones de la bomba en tiempo real

**Nuevas funciones a crear**:
- `renderBombInRoom(roomElement, hasBomb)` - Mostrar/ocultar emoji de bomba
- `updateBombVisibility(gameData)` - Actualizar visibilidad de la bomba seg煤n rol del jugador

**Elementos UI a agregar**:
- Emoji  en la habitaci贸n con bomba (solo visible para asesino)
- Estilos CSS para el emoji de bomba

### 5. Mec谩nica de Muerte por Bomba

**Archivo**: `web/firebase-modular.js` y `web/index.html`

**Funciones a modificar**:
- `finalizeRound()` - Agregar l贸gica para verificar muertes por bomba
- `calculateNewDistribution()` - Considerar muertes por bomba al calcular nueva distribuci贸n

**Nuevas funciones a crear**:
- `checkBombDeaths(gameData, newDistribution)` - Verificar si alg煤n jugador muere por bomba
- `processBombDeaths(gameData, newDistribution)` - Procesar muertes por bomba

## Algoritmo de Colocaci贸n de Bombas

### Paso 1: Validaci贸n de Colocaci贸n
1. Verificar que el jugador es el asesino (`gameData.roles.ASESINO === playerNumber`)
2. Verificar que estamos en fase de movimiento (`gameData.endingRound === true`)
3. Verificar que no hay bomba colocada previamente (`gameData.bombPlaced === null`)
4. Verificar que la habitaci贸n es la actual o contigua usando `roomMovements`

### Paso 2: Obtenci贸n de Habitaciones V谩lidas
1. Obtener habitaci贸n actual del asesino: `getCurrentPlayerRoom(playerNumber, gameData.playerDistribution)`
2. Obtener habitaciones contiguas: `roomMovements[currentRoom]`
3. Incluir habitaci贸n actual en la lista de habitaciones v谩lidas
4. Filtrar solo habitaciones que no sean 'centro'

### Paso 3: Procesamiento de Colocaci贸n
1. Actualizar campo `bombPlaced` con el nombre de la habitaci贸n
2. Ocultar botones de bomba
3. Continuar con movimiento normal

### Paso 4: Visualizaci贸n
1. Solo el asesino ve el emoji de bomba en la habitaci贸n correspondiente
2. La bomba persiste entre rondas
3. Sincronizaci贸n en tiempo real con Firebase

### Paso 5: Mec谩nica de Muerte por Bomba
1. Al finalizar la fase de movimiento, verificar si hay bomba colocada
2. Para cada jugador que se movi贸, verificar si su nueva ubicaci贸n tiene bomba
3. Si un jugador se mueve a una habitaci贸n con bomba, marcarlo como muerto
4. Procesar la muerte junto con las otras muertes de la ronda

## Fases de Implementaci贸n

### Fase 1: Estructura de Datos (Feature 1)
- Modificar `savePlayerDistribution()` para incluir campos de bombas
- Actualizar `finalizeRound()` para manejar bombas
- Crear funciones b谩sicas de validaci贸n

### Fase 2: L贸gica de Colocaci贸n (Feature 2)
- Implementar `placeBomb()` con todas las validaciones
- Crear `validateBombPlacement()` con reglas de negocio
- Integrar con sistema de fases existente

### Fase 3: Interfaz de Colocaci贸n (Feature 3)
- Modificar `enableRoomSelection()` para mostrar botones de bomba
- Crear `handleBombPlacement()` para manejar clics
- Integrar con flujo de movimiento existente

### Fase 4: Visualizaci贸n (Feature 4)
- Modificar `updateRoomDisplay()` para mostrar emojis de bomba
- Implementar `updateBombVisibility()` para control de visibilidad
- Asegurar sincronizaci贸n en tiempo real

### Fase 5: Mec谩nica de Muerte (Feature 5)
- Modificar `finalizeRound()` para verificar muertes por bomba
- Implementar `checkBombDeaths()` y `processBombDeaths()`
- Integrar con sistema de muertes existente

## Consideraciones T茅cnicas

### Integraci贸n con Sistema Existente
- Reutilizar sistema de fases (`endingRound`)
- Integrar con sistema de movimiento existente
- Mantener compatibilidad con roles y visibilidad

### Sincronizaci贸n en Tiempo Real
- Usar `subscribeToGameUpdates()` existente
- Actualizar UI autom谩ticamente cuando cambie la bomba
- Mantener consistencia entre jugadores

### Persistencia de Datos
- La bomba persiste entre rondas
- Limpieza autom谩tica al reiniciar juego

### Experiencia de Usuario
- Botones peque帽os y discretos
- Integraci贸n fluida con movimiento
- Feedback visual claro para el asesino

## Validaciones de Negocio

1. **Solo asesino**: Verificar `gameData.roles.ASESINO === playerNumber`
2. **Solo en fase de movimiento**: Verificar `gameData.endingRound === true`
3. **Solo una bomba**: Verificar `gameData.bombPlaced === null`
4. **Habitaci贸n v谩lida**: Verificar que la habitaci贸n es actual o contigua usando `roomMovements`
5. **Jugador vivo**: Verificar que el asesino no est谩 en `gameData.deads`

## Estructura de Datos Detallada

```javascript
// Ejemplo de datos de bomba en Firebase
{
  // ... otros campos del juego ...
  bombPlaced: "cocina"  // Nombre de la habitaci贸n donde est谩 la bomba
}

// O si no hay bomba colocada:
{
  // ... otros campos del juego ...
  bombPlaced: null
}
```

## Notas de Implementaci贸n

- Mantener compatibilidad con el sistema de roles existente
- Reutilizar funciones existentes: `getCurrentPlayerRoom()` e `isRoomAccessible()`
- Usar el diccionario `roomMovements` para determinar habitaciones contiguas
- Integrar con el sistema de suscripciones en tiempo real
- Asegurar que la UI se actualiza correctamente en todos los dispositivos
- Mantener la est茅tica visual consistente con el resto del juego

## Diccionario de Habitaciones Contiguas (roomMovements)

```javascript
const roomMovements = {
    'cocina': ['pasillo_norte', 'comedor'],
    'pasillo_norte': ['cocina', 'habitacion_principal'],
    'habitacion_principal': ['pasillo_norte', 'habitacion_invitados'],
    'comedor': ['cocina', 'torreon_oeste'],
    'habitacion_invitados': ['habitacion_principal', 'torreon_este'],
    'torreon_oeste': ['comedor', 'pasillo_sur'],
    'pasillo_sur': ['torreon_oeste', 'torreon_este'],
    'torreon_este': ['pasillo_sur', 'habitacion_invitados']
};
```