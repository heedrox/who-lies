<!-- Generated by SpecStory -->

# Fix distribution calculation for nextDeath (2025-08-16 16:38Z)

_**User**_

hay que hacer un fix en este juego @before-implementing-new-features-read-readme.mdc 

cuando se hace calculateNewDsitribution, y se recogen las distribuciones nuevas segun el movimiento que han seleccionado, hay que ignorar el movimiento de la persona que está marcada en el campo "nextDeath" de la BD.

---

_**Assistant**_

I'll help you fix this issue. First, let me read the README to understand the game context, then examine the current code to understand how `calculateNewDistribution` works and where the fix needs to be applied.


---

### Rule: before-implementing-new-features-read-readme

**For implementing new features, get more context of the game**

```markdown
Read @README.md to be able to get more context of this project and the overall game, when implementing new features.
```

---

Read file: README.md

---

Now let me examine the current code to understand how `calculateNewDistribution` works and where the fix needs to be applied:


---

Read file: web/index.html

---

Let me search for the `calculateNewDistribution` function to see the complete implementation:


---

<details>
            <summary>Grep search for "function calculateNewDistribution" • **2** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2292 | `async function calculateNewDistribution() {` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2292 | `async function calculateNewDistribution() {` |

</details>

---

Read file: web/index.html

---

Now let me search for where the `nextDeath` field is used to understand the context better:


---

<details>
            <summary>Grep search for "nextDeath" • **6** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/jordimarti/Development/who-lies/README.md` | L380 | `- **Base de datos**: Campo `nextDeath: X` se actualiza al seleccionar víctima` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L135 | `nextDeath: victimNumber,` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L209 | `const nextDeath = currentData.nextDeath;` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L226 | `if (nextDeath !== undefined && nextDeath !== null) {` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L230 | `if (nextDeath !== null) {` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L232 | `if (!currentDeads.includes(nextDeath)) {` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L233 | `currentDeads.push(nextDeath);` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L234 | `console.log(`💀 JUGADOR ${nextDeath} agregado al array de muertos: [${currentDeads.join(', ')}]`);` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L247 | `// Limpiar campo nextDeath` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L248 | `updateData.nextDeath = firebase.firestore.FieldValue.delete();` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2121 | `const asesinoHasSelected = gameData.nextDeath !== undefined;` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2234 | `console.log(`🔪 nextDeath en gameData:`, window.gameData.nextDeath);` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2238 | `const hasSelectedVictim = window.gameData.nextDeath !== undefined;` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2121 | `const asesinoHasSelected = gameData.nextDeath !== undefined;` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2234 | `console.log(`🔪 nextDeath en gameData:`, window.gameData.nextDeath);` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2238 | `const hasSelectedVictim = window.gameData.nextDeath !== undefined;` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L135 | `nextDeath: victimNumber,` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L209 | `const nextDeath = currentData.nextDeath;` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L226 | `if (nextDeath !== undefined && nextDeath !== null) {` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L230 | `if (nextDeath !== null) {` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L232 | `if (!currentDeads.includes(nextDeath)) {` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L233 | `currentDeads.push(nextDeath);` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L234 | `console.log(`💀 JUGADOR ${nextDeath} agregado al array de muertos: [${currentDeads.join(', ')}]`);` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L247 | `// Limpiar campo nextDeath` |
| `file:///Users/jordimarti/Development/who-lies/web/firebase-config.js` | L248 | `updateData.nextDeath = firebase.firestore.FieldValue.delete();` |
| `file:///Users/jordimarti/Development/who-lies/README.md` | L380 | `- **Base de datos**: Campo `nextDeath: X` se actualiza al seleccionar víctima` |

</details>

---

Let me check the firebase-config.js file to understand how the `nextDeath` field is processed:


---

Read file: web/firebase-config.js

---

Now I understand the issue! The problem is in the `calculateNewDistribution` function. When calculating the new distribution based on player movements, it should ignore the movement of the player marked in the `nextDeath` field because that player is about to die and shouldn't be moved to their new location.

Let me examine the current logic and implement the fix:


---

<details><summary>Edit file: web/index.html</summary>

undefined

**Chunk 1**
Lines added: 13, lines removed: undefined

```diff
@@ -2311,4 +2311,17 @@
                  // Mover jugadores a sus nuevas ubicaciones
                  for (let i = 1; i <= window.gameParams.totalPlayers; i++) {
+                     // Verificar si este jugador está marcado para morir en nextDeath
+                     if (gameData.nextDeath === i) {
+                         console.log(`💀 Ignorando movimiento del jugador ${i} (marcado para morir)`);
+                         // Mantener al jugador en su ubicación actual (no moverlo)
+                         for (let room in oldDistribution) {
+                             if (oldDistribution[room] && oldDistribution[room].includes(i)) {
+                                 newDistribution[room].push(i);
+                                 break;
+                             }
+                         }
+                         continue; // Saltar al siguiente jugador
+                     }
+                     
                      const fieldName = `player${i}NextMovement`;
                      const nextRoom = gameData[fieldName];
```

</details>

---

Perfect! I've implemented the fix for the issue. Here's what the fix does:

## �� Fix Implementado

**Problema identificado**: Cuando se ejecuta `calculateNewDistribution`, la función estaba procesando el movimiento de todos los jugadores, incluyendo al jugador marcado en el campo `nextDeath` de la base de datos.

**Solución implementada**: Antes de procesar el movimiento de cada jugador, ahora se verifica si ese jugador está marcado para morir (`gameData.nextDeath === i`). Si es así:

1. **Se ignora su movimiento**: No se procesa el campo `player{i}NextMovement`
2. **Se mantiene en su ubicación actual**: Se busca en la distribución anterior y se coloca en la misma habitación
3. **Se registra en consola**: Para debugging, se muestra un mensaje indicando que se ignoró el movimiento
4. **Se continúa con el siguiente jugador**: Se usa `continue` para saltar al siguiente en el bucle

## 🎯 Cómo funciona el fix

```javascript
// Verificar si este jugador está marcado para morir en nextDeath
if (gameData.nextDeath === i) {
    console.log(`💀 Ignorando movimiento del jugador ${i} (marcado para morir)`);
    // Mantener al jugador en su ubicación actual (no moverlo)
    for (let room in oldDistribution) {
        if (oldDistribution[room] && oldDistribution[room].includes(i)) {
            newDistribution[room].push(i);
            break;
        }
    }
    continue; // Saltar al siguiente jugador
}
```

## 🎮 Flujo del juego corregido

1. **El ASESINO selecciona una víctima** → Se marca en `nextDeath: X`
2. **Se ejecuta `calculateNewDistribution`** → Se ignoran los movimientos del jugador marcado para morir
3. **Se finaliza la ronda** → El jugador marcado se agrega al array `deads[]` y se elimina `nextDeath`
4. **La nueva distribución se aplica** → Sin el jugador muerto (que ya no está en la distribución)

Este fix asegura que el jugador marcado para morir no se mueva a su nueva ubicación antes de ser procesado como muerto, manteniendo la consistencia del juego y evitando que aparezca en dos lugares diferentes.

---

_**User**_

ahora @explain-features-in-readme-before-commiting.mdc 

---

_**Assistant**_

I'll update the README.md to document the new fix that was implemented. Let me add this feature to the appropriate section.


---

### Rule: explain-features-in-readme-before-commiting

**Just before (or when) doing git commit and push of new features**

```markdown
Always update README.md to specify added features.
```

---

Now I'll update the README.md to document the fix that was implemented for the `calculateNewDistribution` function:


---

<details><summary>Edit file: README.md</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -447,4 +447,5 @@
  - **Actualización garantizada de BD**: Siempre se registra la decisión del ASESINO en Firebase
  - **Sistema robusto**: Maneja casos edge como habitaciones sin víctimas vivas
+ - **Prevención de movimiento de víctimas**: Los jugadores marcados en `nextDeath` no se mueven antes de ser procesados como muertos
  
  ### 🎨 Interfaz de Usuario y Experiencia
```

</details>

---

Now let me add a more detailed explanation in the technical improvements section:


---

<details><summary>Edit file: README.md</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -471,4 +471,5 @@
  - **Manejo de casos edge**: Validaciones robustas para situaciones especiales
  - **Información de roles para ASESINO y COMPLICE**: Los jugadores con roles especiales pueden ver información adicional sobre otros roles en su perfil
+ - **Fix de distribución de víctimas**: La función `calculateNewDistribution` ahora ignora los movimientos de jugadores marcados en `nextDeath` para evitar inconsistencias en la ubicación antes de procesar la muerte
  
  ### 🛡️ Seguridad y Balance del Juego
```

</details>

---

Now let me add this fix to the completed features list:


---

<details><summary>Edit file: README.md</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -491,4 +491,5 @@
  - [x] **Información de roles para ASESINO y COMPLICE** - Los jugadores con roles especiales pueden ver información adicional sobre otros roles en su perfil
  - [x] **Sistema de acusaciones colectivas** - El jugador 1 actúa como director de juego para ejecutar acusaciones grupales
+ - [x] **Fix de distribución de víctimas** - Los jugadores marcados para morir no se mueven antes de ser procesados como muertos
  - [ ] **Base de datos de pistas** - Sistema de pistas dinámicas y aleatorias
  - [x] **Modo multijugador** - Sincronización en tiempo real entre jugadores
```

</details>

---

Perfect! I've updated the README.md to document the new fix that was implemented. Here's a summary of what was added:

## 📝 README.md Actualizado

### ✅ Nuevas características documentadas:

1. **En la sección "Mecánica de Asesinato Optimizada"**:
   - Agregado: "**Prevención de movimiento de víctimas**: Los jugadores marcados en `nextDeath` no se mueven antes de ser procesados como muertos"

2. **En la sección "Mejoras Técnicas y Arquitectura"**:
   - Agregado: "**Fix de distribución de víctimas**: La función `calculateNewDistribution` ahora ignora los movimientos de jugadores marcados en `nextDeath` para evitar inconsistencias en la ubicación antes de procesar la muerte"

3. **En la lista de funcionalidades completadas**:
   - Agregado: "**Fix de distribución de víctimas** - Los jugadores marcados para morir no se mueven antes de ser procesados como muertos"

### 🎯 Descripción del fix documentada:

El README ahora explica claramente que:
- Se implementó un fix en la función `calculateNewDistribution`
- El fix previene que los jugadores marcados para morir se muevan antes de ser procesados
- Esto evita inconsistencias en la ubicación de los jugadores
- El sistema mantiene la consistencia del juego durante el proceso de muerte

Ahora el README está completamente actualizado y documenta la nueva funcionalidad implementada, siguiendo la regla de explicar las características antes de hacer commit.

---

_**User**_

commit & push

---

_**Assistant**_

I'll help you commit and push the changes. Let me run the git commands to commit the fix and push it to the repository.


---

```bash
cd /Users/jordimarti/Development/who-lies && git add .
```

```
(base) ➜  who-lies cd /Users/jordimarti/Development/who-lies && git add .
(base) ➜  who-lies
```

---

```bash
git status
```

```
(base) ➜  who-lies git:(main) ✗ git status
On branch main
Your branch is up to date with 'origin/main'.

Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        modified:   README.md
        modified:   web/firebase-config.js
        modified:   web/index.html

(base) ➜  who-lies git:(main) ✗
```

---

```bash
git commit -m "Fix: Ignorar movimientos de jugadores marcados para morir en calculateNewDistribution

- Implementa verificación de nextDeath antes de procesar movimientos
- Previene que jugadores marcados para morir se muevan antes de ser procesados
- Mantiene consistencia en la ubicación durante el proceso de muerte
- Agrega logs de debugging para seguimiento del comportamiento
- Actualiza README.md con documentación de la nueva funcionalidad"
```

```
<ADME.md con documentación de la nueva funcionalidad"
[main ba9010a] Fix: Ignorar movimientos de jugadores marcados para morir en calculateNewDistribution
 3 files changed, 18 insertions(+), 2 deletions(-)
```

---

```bash
git push origin main
```

```
(base) ➜  who-lies git:(main) git push origin main
Enumerating objects: 11, done.
Counting objects: 100% (11/11), done.
Delta compression using up to 8 threads
Compressing objects: 100% (6/6), done.
Writing objects: 100% (6/6), 1.24 KiB | 1.24 MiB/s, done.
Total 6 (delta 4), reused 0 (delta 0), pack-reused 0
remote: Resolving deltas: 100% (4/4), completed with 4 local objects.
To github.com:heedrox/who-lies.git
   95e826b..ba9010a  main -> main
(base) ➜  who-lies git:(main)
```

---

Perfect! ✅ The changes have been successfully committed and pushed to the repository.

## 🚀 Commit & Push Completado

### �� Resumen del commit:
- **Commit ID**: `ba9010a`
- **Archivos modificados**: 3 archivos
- **Cambios**: 18 inserciones, 2 eliminaciones
- **Branch**: `main`
- **Remote**: `origin/main`

### 🔧 Cambios implementados:
1. **Fix en `calculateNewDistribution`**: Los jugadores marcados en `nextDeath` ya no se mueven antes de ser procesados como muertos
2. **Documentación actualizada**: README.md actualizado con la nueva funcionalidad
3. **Logs de debugging**: Agregados para seguimiento del comportamiento

### 🎯 Estado del repositorio:
- ✅ Cambios staged y commitados
- ✅ Push exitoso al repositorio remoto
- ✅ Branch `main` actualizado
- ✅ Repositorio sincronizado

El fix está ahora completamente implementado, documentado y disponible en el repositorio remoto. Los jugadores marcados para morir ya no se moverán a nuevas ubicaciones antes de ser procesados como muertos, manteniendo la consistencia del juego.

---

