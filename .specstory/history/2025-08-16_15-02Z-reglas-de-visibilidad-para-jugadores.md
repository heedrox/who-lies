<!-- Generated by SpecStory -->

# Reglas de visibilidad para jugadores (2025-08-16 15:02Z)

_**User**_

@before-implementing-new-features-read-readme.mdc podrias decirme si cuando se asigna la visibilidad a cada jugador, cual es la regla?

---

_**Assistant**_

I'll read the README.md file to understand the game context and find information about the visibility assignment rules for players.


---

Read file: README.md

---

Bas√°ndome en la lectura del README.md, puedo explicarte las reglas de visibilidad cuando se asigna a cada jugador:

## üëÅÔ∏è Reglas de Visibilidad del Sistema

### **Visibilidad por Habitaci√≥n (para INVITADOS)**
Cada habitaci√≥n solo puede ver a habitaciones contiguas espec√≠ficas:

- **Cocina**: Ve a Pasillo Norte y Comedor
- **Pasillo Norte**: Ve a Cocina y Habitaci√≥n Principal  
- **Habitaci√≥n Principal**: Ve a Pasillo Norte y Habitaci√≥n Invitados
- **Comedor**: Ve a Cocina y Torre√≥n Oeste
- **Habitaci√≥n Invitados**: Ve a Habitaci√≥n Principal y Torre√≥n Este
- **Torre√≥n Oeste**: Ve a Comedor y Pasillo Sur
- **Pasillo Sur**: Ve a Torre√≥n Oeste y Torre√≥n Este
- **Torre√≥n Este**: Ve a Pasillo Sur y Habitaci√≥n Invitados

### **Ventaja para Roles Especiales**
- **ASESINO**: Puede ver a TODOS los jugadores en TODAS las habitaciones
- **COMPLICE**: Puede ver a TODOS los jugadores en TODAS las habitaciones

### **Caracter√≠sticas del Sistema**
- **Probabilidad del 60%**: Para INVITADOS, se aplica una sola vez al generar la distribuci√≥n, no en cada actualizaci√≥n
- **Sin rec√°lculo**: Cada jugador mantiene la misma visibilidad durante toda la partida
- **Sistema centralizado**: Se genera un diccionario de visibilidad al crear la distribuci√≥n
- **Almacenamiento en Firebase**: La visibilidad se guarda junto con la distribuci√≥n y roles para consistencia

### **Ejemplo de Visibilidad**
Si eres un INVITADO en la Cocina, solo podr√°s ver jugadores en:
- Pasillo Norte
- Comedor

Pero si eres el ASESINO o COMPLICE, podr√°s ver jugadores en todas las habitaciones, independientemente de d√≥nde est√©s ubicado.

Este sistema fomenta la deducci√≥n y la colaboraci√≥n entre jugadores, ya que cada uno tiene informaci√≥n parcial que debe ser combinada para resolver el misterio.

---

_**User**_

Puedes confirmar eso con el codigo?

---

_**Assistant**_

Tienes raz√≥n, deber√≠a verificar el c√≥digo para confirmar exactamente c√≥mo funciona el sistema de visibilidad. D√©jame buscar el c√≥digo relevante.


---

<details>
                <summary>Searched codebase "sistema de visibilidad entre habitaciones reglas de visibilidad" ‚Ä¢ **15** results</summary>
            
| File | Lines |
|------|-------|
| `README.md` | L396-419 |
| `web/index.html` | L2304-2344 |
| `web/index.html` | L2340-2381 |
| `README.md` | L27-66 |
| `web/index.html` | L1998-2046 |
| `web/index.html` | L979-1014 |
| `web/index.html` | L2379-2427 |
| `web/index.html` | L1034-1056 |
| `web/index.html` | L960-981 |
| `web/index.html` | L2206-2228 |
| `web/index.html` | L1012-1036 |
| `README.md` | L64-99 |
| `web/index.html` | L1956-2002 |
| `web/index.html` | L1404-1438 |
| `web/index.html` | L2171-2208 |

</details>

---

Ahora d√©jame buscar m√°s espec√≠ficamente el c√≥digo que implementa las reglas de visibilidad:


---

<details>
            <summary>Grep search for "roomVisibility" ‚Ä¢ **2** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L994 | `const visibleRooms = roomVisibility[playerRoom] || [];` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2020 | `const roomVisibility = {` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2031 | `const contiguousRooms = roomVisibility[currentRoom] || [];` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2328 | `const roomVisibility = {` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2341 | `console.log(roomVisibility);` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2377 | `const visibleRooms = roomVisibility[playerRoom] || [];` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2412 | `const visibleRooms = roomVisibility[playerRoom] || [];` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L994 | `const visibleRooms = roomVisibility[playerRoom] || [];` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2020 | `const roomVisibility = {` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2031 | `const contiguousRooms = roomVisibility[currentRoom] || [];` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2328 | `const roomVisibility = {` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2341 | `console.log(roomVisibility);` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2377 | `const visibleRooms = roomVisibility[playerRoom] || [];` |
| `file:///Users/jordimarti/Development/who-lies/web/index.html` | L2412 | `const visibleRooms = roomVisibility[playerRoom] || [];` |

</details>

---

Perfecto, ahora d√©jame leer la secci√≥n espec√≠fica donde se define el diccionario `roomVisibility`:


---

Read file: web/index.html

---

Ahora d√©jame ver la funci√≥n `generatePlayerVisibility` que es donde se aplica la probabilidad del 60%:


---

Read file: web/index.html

---

Perfecto! Ahora puedo confirmar exactamente c√≥mo funciona el sistema de visibilidad bas√°ndome en el c√≥digo. Aqu√≠ est√° la confirmaci√≥n:

## ‚úÖ **CONFIRMACI√ìN DEL C√ìDIGO - Sistema de Visibilidad**

### **1. Diccionario de Visibilidad entre Habitaciones (L√≠neas 2327-2335)**
```javascript
const roomVisibility = {
    'cocina': ['pasillo_norte', 'comedor'],
    'pasillo_norte': ['cocina', 'habitacion_principal'],
    'habitacion_principal': ['pasillo_norte', 'habitacion_invitados'],
    'comedor': ['cocina', 'torreon_oeste'],
    'habitacion_invitados': ['habitacion_principal', 'torreon_este'],
    'torreon_oeste': ['comedor', 'pasillo_sur'],
    'pasillo_sur': ['torreon_oeste', 'torreon_este'],
    'torreon_este': ['pasillo_sur', 'habitacion_invitados']
};
```

### **2. Reglas de Visibilidad por Rol (L√≠neas 970-1010)**

**Para ASESINO y COMPLICE:**
- Pueden ver a **TODOS** los jugadores en **TODAS** las habitaciones
- No se aplica probabilidad del 60%
- Visibilidad completa garantizada

**Para INVITADOS:**
- Solo ven jugadores en habitaciones contiguas seg√∫n `roomVisibility`
- Se aplica **probabilidad del 60% UNA SOLA VEZ** al generar la distribuci√≥n
- La visibilidad se mantiene constante durante toda la partida

### **3. Aplicaci√≥n de la Probabilidad del 60% (L√≠neas 1000-1010)**
```javascript
// Para INVITADOS, aplicar 60% de probabilidad UNA SOLA VEZ
if (playerRole === 'INVITADO/A') {
    const finalVisiblePlayers = [];
    visiblePlayers.forEach(playerNum => {
        if (Math.random() < 0.6) {
            finalVisiblePlayers.push(playerNum);
        }
    });
    visibility[playerNum] = finalVisiblePlayers.sort((a, b) => a - b);
}
```

### **4. Funci√≥n de Aplicaci√≥n de Probabilidad (L√≠neas 1012-1030)**
```javascript
function applyVisibilityProbability(playerNumber, playerVisibility, roles) {
    // ASESINO y COMPLICE ven a TODOS los jugadores (sin probabilidad)
    if (playerRole === 'ASESINO/A' || playerRole === 'COMPLICE') {
        return baseVisiblePlayers;
    }
    
    // Para INVITADOS, usar la visibilidad ya determinada (sin recalcular)
    return baseVisiblePlayers;
}
```

## üéØ **RESUMEN CONFIRMADO**

1. **Las reglas del README son 100% correctas** ‚úÖ
2. **El c√≥digo implementa exactamente lo descrito** ‚úÖ
3. **La probabilidad del 60% se aplica UNA SOLA VEZ** al generar la distribuci√≥n ‚úÖ
4. **ASESINO y COMPLICE tienen visibilidad completa** ‚úÖ
5. **INVITADOS tienen visibilidad limitada por habitaci√≥n + probabilidad del 60%** ‚úÖ

El sistema est√° perfectamente implementado seg√∫n la documentaci√≥n del README.

---

_**User**_

¬øsi un jugador esta en una habitacion, ve tambien a los jugadores de esa habitacion o solo las de los contiguos?

---

_**Assistant**_

Excelente pregunta. D√©jame revisar el c√≥digo para confirmar exactamente c√≥mo funciona la visibilidad cuando un jugador est√° en una habitaci√≥n.


---

Read file: web/index.html

---

Ahora d√©jame ver tambi√©n la funci√≥n `getVisiblePlayers` para confirmar que funciona igual:


---

Read file: web/index.html

---

Perfecto! Ahora puedo confirmar exactamente c√≥mo funciona la visibilidad. Bas√°ndome en el c√≥digo:

## ‚úÖ **CONFIRMACI√ìN: Un jugador S√ç ve a los jugadores de su propia habitaci√≥n**

### **ÔøΩÔøΩ Visibilidad Completa (L√≠neas 1000-1002 y 2385-2387)**

```javascript
// Tambi√©n incluir a los jugadores que est√°n en la misma habitaci√≥n
if (playerDistribution[playerRoom]) {
    visiblePlayers.push(...playerDistribution[playerRoom]);
}
```

### **üéØ C√≥mo Funciona la Visibilidad para INVITADOS:**

1. **Jugadores en habitaciones contiguas** (seg√∫n `roomVisibility`)
2. **Jugadores en su propia habitaci√≥n** ‚úÖ
3. **Se excluye al propio jugador** (l√≠nea 1004: `visiblePlayers.splice(visiblePlayers.indexOf(playerNum), 1)`)

### **üîç Ejemplo Pr√°ctico:**

Si el **JUGADOR 3** est√° en la **COCINA**:

**Puede ver:**
- ‚úÖ **Jugadores en COCINA** (su propia habitaci√≥n, excepto a s√≠ mismo)
- ‚úÖ **Jugadores en PASILLO NORTE** (habitaci√≥n contigua)
- ‚úÖ **Jugadores en COMEDOR** (habitaci√≥n contigua)

**NO puede ver:**
- ‚ùå Jugadores en HABITACI√ìN PRINCIPAL
- ‚ùå Jugadores en HABITACI√ìN INVITADOS
- ‚ùå Jugadores en TORRE√ìN OESTE
- ‚ùå Jugadores en PASILLO SUR
- ‚ùå Jugadores en TORRE√ìN ESTE

### **üëë Para ASESINO y COMPLICE:**

- Ven a **TODOS** los jugadores en **TODAS** las habitaciones
- Incluyendo su propia habitaci√≥n
- Sin restricciones de visibilidad

### **üìä Resumen de Visibilidad:**

| Tipo de Jugador | Su Habitaci√≥n | Habitaciones Contiguas | Otras Habitaciones |
|------------------|----------------|------------------------|---------------------|
| **INVITADO** | ‚úÖ Ve a todos | ‚úÖ Ve a todos | ‚ùå No ve a nadie |
| **ASESINO** | ‚úÖ Ve a todos | ‚úÖ Ve a todos | ‚úÖ Ve a todos |
| **COMPLICE** | ‚úÖ Ve a todos | ‚úÖ Ve a todos | ‚úÖ Ve a todos |

**Respuesta directa:** S√≠, un jugador ve tanto a los jugadores de su propia habitaci√≥n como a los de las habitaciones contiguas.

---

_**User**_

ok, gracias

---

_**Assistant**_

¬°De nada! üòä 

Me alegra haber podido confirmar con el c√≥digo exactamente c√≥mo funciona el sistema de visibilidad. Es un sistema muy bien dise√±ado que:

- **Fomenta la colaboraci√≥n** entre jugadores (cada uno tiene informaci√≥n parcial)
- **Mantiene el misterio** con la probabilidad del 60% para INVITADOS
- **Da ventajas t√°cticas justas** a ASESINO y COMPLICE
- **Es consistente** durante toda la partida

Si tienes m√°s preguntas sobre el juego o necesitas que revise alguna otra funcionalidad del c√≥digo, ¬°no dudes en preguntarme! üïµÔ∏è‚Äç‚ôÇÔ∏èüéÆ

---

